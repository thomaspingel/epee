<html>
<head>
<title>Pingel's Epee Scoring Box</title>
<style>
	body {
		background-color: black;
		color: yellow;
		font-size: 10em;
		text-align: center;
	}
	.hit_indicator {
		background-color: black;
		width: 50%;
		height: 80%;
		text-align: center;
		font-size: 10em;
    }


</style>

</head>
<body>
<!-- <div id = "timer" style="height:20%; width:100%" onclick="setTime()"></div> -->
<table height="80%" width="100%">
<tr>
<td id="left_light" class="hit_indicator">0</td>
<td id="right_light" class="hit_indicator">0</td>
</tr>
</table>



<script>
	document.getElementById("left_light").style.backgroundColor = "black";
	document.getElementById("right_light").style.backgroundColor = "black";

	// What buttons is the hardware connected to?
	var LEFT_A_BUTTON = 0;
	var LEFT_C_BUTTON = 1;
	var RIGHT_A_BUTTON = 10;
	var RIGHT_C_BUTTON = 11;
	
	var lightDuration = 2000;
	
	LA = false
	RA = false
	
	last_hit_time = 0;
	
	function update() {
		gp = navigator.getGamepads()[0];
		if (gp != null) {
			if (gp.buttons[LEFT_A_BUTTON].pressed && LA == false) {
				LA = true;
				epee("la",gp.timestamp);
			}
			else { LA = false; }
			if (gp.buttons[RIGHT_A_BUTTON].pressed && RA == false) {
				RA = true;
				epee("ra",gp.timestamp);
			}
			else { RA = false; }
		}
	}
	setInterval(update,5);
	
	function epee(wire,timestamp) {
		if (wire=="la" && document.getElementById("left_light").style.backgroundColor == "black") {
			if (document.getElementById("right_light").style.backgroundColor == "black") {
				turnOnLight('left','red',timestamp);
			} else {
				if (timestamp - last_hit_time <= 50) {
					turnOnLight('left','red',timestamp);
				} else {
					// console.log("Too long: ",timestamp - last_hit_time);
				}
			}
		}
		if (wire=="ra" && document.getElementById("right_light").style.backgroundColor == "black") {
			if (document.getElementById("left_light").style.backgroundColor == "black") {
				turnOnLight('right','green',timestamp);
			} else {
				if (timestamp - last_hit_time <= 50) {
					turnOnLight('right','green',timestamp);
				} else {
					// console.log("Too long: ",timestamp - last_hit_time);
				}
			}
		}
	}
	
	
	function turnOnLight(side,color,timestamp){
		// If we've gotten a signal to turn on a light, but both lights are black, that's a new hit.
		left_black = document.getElementById("left_light").style.backgroundColor == "black";
		right_black = document.getElementById("right_light").style.backgroundColor=="black";
		if (left_black && right_black) {
			last_hit_time = timestamp;
			console.log("that's a hit");
			console.log(last_hit_time);
			playBuzzer();
		}
		
		if (document.getElementById(side + "_light").style.backgroundColor == "black") {
			document.getElementById(side + "_light").style.backgroundColor = color;
			setTimeout(turnOffLights,lightDuration);
		}
		
	}
	
	function turnOffLights(){
		document.getElementById("left_light").style.backgroundColor = "black";	
		document.getElementById("right_light").style.backgroundColor = "black";	
	}
	
	
		
	
</script>



<script>
    /* SOUND HANDLING */
	
	var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
	var buzzer = audioCtx.createOscillator();
	var gainNode = audioCtx.createGain();
	

	gainNode.gain.value = 0.0;  // Set sound "off" initially; turn on when a hit happens.

	buzzer.connect(gainNode);
	gainNode.connect(audioCtx.destination);

	// set options for the oscillator
	buzzer.type = 'sine';
	buzzer.frequency.value = 500; // value in hertz, should be between about 500 (low tone) to 2000 (high tone)
	buzzer.start(0);
	
	function playBuzzer(){
		// console.log('playing_buzzer');
		gainNode.gain.value = 1.0;
		setTimeout(function (){gainNode.gain.value = 0.0;},lightDuration);
	}
</script>


</body>
</html>